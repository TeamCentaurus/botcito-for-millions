name: "Bot Smart Deploy"

on:
  workflow_run:
    workflows: ["Infrastructure Deployment"]
    types: [completed]
  push:
    branches: [ main ]

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' || 
      (github.event_name == 'push' && github.event.workflow_run == null)
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Necesitamos comparar con el commit anterior

      - name: Sync Repository on VM
        run: |
          echo "Configurando directorio seguro..."
          # Esto evita el error de 'dubious ownership'
          git config --global --add safe.directory /opt/botcito
          
          echo "Sincronizando archivos..."
          cd /opt/botcito
          sudo git fetch origin main
          sudo git reset --hard origin/main 
          
          echo "Ajustando permisos de grupo..."
          sudo chown -R :botcito-devs .
          sudo chmod -R 775 .
          
      - name: Fix Permissions for Airflow
        run: |
          cd /opt/botcito
          sudo chown -R 50000:0 logs dags plugins src
          sudo chmod -R 775 logs dags plugins src

      - name: Analyze Changes and Deploy
        run: |
          cd /opt/botcito
          
          # 1. Detectar si hay contenedores del proyecto corriendo
          # Usamos sudo para evitar cualquier restricción del socket de docker
          RUNNING_CONTAINERS=$(sudo docker ps -a --filter "label=com.docker.compose.project=botcito" -q)
          
          # 2. Detectar cambios críticos comparando con el commit anterior
          CRITICAL_CHANGES=$(git diff --name-only HEAD^ HEAD | grep -E 'docker/|src/|pyproject.toml|uv.lock|docker-compose.yml' || true)
          
          if [ -z "$RUNNING_CONTAINERS" ]; then
            echo "ESTADO: No hay contenedores. Iniciando primer levantamiento..."
            sudo docker-compose up -d --build
          elif [ -n "$CRITICAL_CHANGES" ]; then
            echo "ESTADO: Cambios críticos detectados. Reconstruyendo imágenes..."
            sudo docker-compose up -d --build
          else
            echo "ESTADO: Cambios menores (DAGs/Configs). Actualizando sin rebuild..."
            # Docker-compose es inteligente: si no hay cambios en el .yml, no hará nada.
            sudo docker-compose up -d
          fi

      - name: Verify Deployment
        run: |
          cd /opt/botcito
          sudo docker-compose --env-file .env ps

      - name: Cleanup
        run: docker image prune -f